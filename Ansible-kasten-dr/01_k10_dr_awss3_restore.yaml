---
- name: Kasten K10 Restore configuration from Disaster Recovery backup
  hosts: localhost
  vars:
    k10_ns: "kasten-io"  
  vars_files:
    - vars/k10eksdr_vars.yaml 
  collections:
    - kubernetes.core

  tasks:
    - name: CREATE AWS S3 SECRET
      kubernetes.core.k8s:
        state: present
        definition: 
          apiVersion: v1
          kind: Secret
          type: secrets.kanister.io/aws             
          metadata:
            name: "{{ secret_name }}"
            namespace: "{{ k10_ns }}"     
          data:
            aws_access_key_id: "{{ aws_access_key_id|b64encode }}"
            aws_secret_access_key: "{{ aws_secret_access_key|b64encode }}"            
                

    # Creating an Location Profile with DR Data and Immutability
    - name: Creating an Location Profile with DR Data
      kubernetes.core.k8s:
        state: present
        definition: 
            apiVersion: config.kio.kasten.io/v1alpha1
            kind: Profile
            metadata:
              name: "{{ profile_name }}"
              namespace: kasten-io
            spec:
              type: Location
              locationSpec:
                credential:
                  secretType: AwsAccessKey
                  secret:
                    apiVersion: v1
                    kind: Secret
                    name: "{{ secret_name }}"
                    namespace: kasten-io
                type: ObjectStore
                objectStore:
                  name: "{{ bucket_name }}"
                  objectStoreType: S3
                  region: "{{ region }}"

    - name: restore Kasten DR Backup
      include_tasks: k10dr/dr_restorek10.yaml      
