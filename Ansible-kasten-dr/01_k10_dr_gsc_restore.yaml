---
- name: Kasten K10 Restore configuration from Disaster Recovery backup
  hosts: localhost
  vars:
    k10_ns: "kasten-io"  
  vars_files:
    - vars/k10gkedr_vars.yaml    
  collections:
    - kubernetes.core
    
  tasks:
    - name: get Google Storage Account Key
      shell:
        "base64 -b 0 -i vars/google-sa-key.json"
      register: sa_key

    - name: CREATE GCS Storage bucket SECRET
      kubernetes.core.k8s:
        state: present
        definition: 
          apiVersion: v1
          kind: Secret
          type: Opaque             
          metadata:
            name: "{{ secret_name }}"
            namespace: "{{ k10_ns }}"     
          data:
            project-id: "{{ project_id|b64encode }}"
            service-account.json: "{{ sa_key.stdout }}"            
      when: (sa_key.stdout)            

    # Creating an Location Profile with DR Data and Immutability
    - name: Creating an Location Profile with DR Data
      kubernetes.core.k8s:
        state: present
        definition: 
            apiVersion: config.kio.kasten.io/v1alpha1
            kind: Profile
            metadata:
              name: "{{ profile_name }}"
              namespace: kasten-io
            spec:
              type: Location
              locationSpec:
                credential:
                  secretType: GcpServiceAccountKey
                  secret:
                    apiVersion: v1
                    kind: Secret
                    name: "{{ secret_name }}"
                    namespace: kasten-io
                type: ObjectStore
                objectStore:
                  name: "{{ bucket_name }}"
                  objectStoreType: GCS 
                  region: "{{ region }}"

    - name: restore Kasten DR Backup
      include_tasks: k10dr/dr_restorek10.yaml
      
